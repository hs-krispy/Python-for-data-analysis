## 데이터 집계와 그룹 연산

<img src="https://user-images.githubusercontent.com/58063806/119824436-deaac100-bf30-11eb-8364-0a3cef9918d6.png" width=30% />

```python
for (k1, k2), group in df.groupby(["key1", "key2"]):
    print((k1, k2))
    print(group)
```

<img src="https://user-images.githubusercontent.com/58063806/119824502-eff3cd80-bf30-11eb-981f-44d623654c4b.png" width=25% />

- groupby 객체는 이터레이션을 지원 (그룹 이름과 그에 따른 데이터 묶음을 투플로 반환)

```python
pieces = dict(list(df.groupby("key1")))
pieces["b"]
```

<img src="https://user-images.githubusercontent.com/58063806/119824713-2893a700-bf31-11eb-9aa8-8a2555f4ad7b.png" width=30% />

- groupby 객체를 사전형으로 바꿔서 원하는 데이터만 추출 가능

```python
df.dtypes
grouped = df.groupby(df.dtypes, axis=1)
for dtype, group in grouped:
    print(dtype)
    print(group)
```

<img src="https://user-images.githubusercontent.com/58063806/119825424-e61e9a00-bf31-11eb-9b6a-d30670fb6a1a.png" width=20% />

- groupby 메서드는 기본적으로 axis=0(행)에 대해 그룹을 만드는데, 다른 축으로 그룹을 만드는 것도 가능

#### 사전과 series에서 그룹핑

<img src="https://user-images.githubusercontent.com/58063806/119826856-6f829c00-bf33-11eb-9fc5-31f098066c07.png" width=50% />

```python
mapping = {"a":"red", "b":"red", "c":"blue", "d":"blue", "e":"red", "f":"orange"}

# 사용하지 않는 그룹 키(f)가 있어도 문제없음
by_column = people.groupby(mapping, axis=1)
by_column.sum()
```

<img src="https://user-images.githubusercontent.com/58063806/119826970-92ad4b80-bf33-11eb-847a-822f10904d28.png" width=20% />

```python
map_series = pd.Series(mapping)
# a       red
# b       red
# c      blue
# d      blue
# e       red
# f    orange

people.groupby(map_series, axis=1).count()
```

<img src="https://user-images.githubusercontent.com/58063806/119827278-eb7ce400-bf33-11eb-91e7-7310f71f3063.png" width=15% />

- 그룹 키를 바탕으로 열에 대해 sum, count 연산을 수행

#### 함수로 그룹핑

- 좀 더 일반적인 방법으로 **그룹 색인으로 넘긴 함수는 색인값 하나마다 한 번씩 호출**되며, **반환값은 그 그룹의 이름**으로 사용

```python
people.groupby(len).sum()
```

<img src="https://user-images.githubusercontent.com/58063806/119827822-8675be00-bf34-11eb-9fb2-25f633b0ee6b.png" width=50% />

- 이름의 길이별로 그룹을 묶은 결과 (len 함수 사용)

```python
key_list = ["one", "one", "one", "two", "two"]

people.groupby([len, key_list]).min()
```

<img src="https://user-images.githubusercontent.com/58063806/119828612-4c58ec00-bf35-11eb-8d26-42b3658f966d.png" width=50% />

- 내부적으로는 모두 배열로 반환되므로, 함수를 배열, 사전이나 series와 섞어 쓰기 가능

#### 색인 단계로 그룹핑

```python
columns = pd.MultiIndex.from_arrays([["US", "US", "US", "JP", "JP"],
                                    [1, 3, 5, 1, 3]],
                                   names=["cty", "tenor"])
hier_df = pd.DataFrame(np.random.randn(4, 5), columns=columns)
hier_df
```

<img src="https://user-images.githubusercontent.com/58063806/119829649-6d6e0c80-bf36-11eb-8151-14a9796b61f0.png" width=50% />

```python
hier_df.groupby(level="cty", axis=1).count()
```

<img src="https://user-images.githubusercontent.com/58063806/119829719-7eb71900-bf36-11eb-80ee-2d67b80cc504.png" width=15% />

- level 예약어를 사용해서 레벨 번호나 이름을 넘겨서 사용가능

#### 데이터 집계

- count, sum, mean, median, std, var, min, max, prod, first, last 등의 최적화된 메서드가 있음
- 사용자 정의 집계함수도 사용가능
  - 사용자 정의 집계함수는 일반적으로 최적화된 메서드에 비해 매우 느리게 동작
  - 중간 데이터를 생성하는 과정에서 함수 호출이나 정렬같은 오버헤드가 발생하기 때문

```python
def peak_to_peak(arr):
    return arr.max() - arr.min()

df.groupby("key1").agg(peak_to_peak)
```

<img src="https://user-images.githubusercontent.com/58063806/119834104-9e504080-bf3a-11eb-9588-bc29bddf2665.png" width=25% />



<img src="https://user-images.githubusercontent.com/58063806/119834976-63024180-bf3b-11eb-8fd3-5856c88a35b2.png" width=50% />

```python
grouped = tips.groupby(["day", "smoker"])
grouped_pct = grouped["tip_pct"]
grouped_pct.agg(["mean", "std", peak_to_peak])
```

<img src="https://user-images.githubusercontent.com/58063806/119835117-80cfa680-bf3b-11eb-87b0-d19ca27b3ba1.png" width=45% />

- 한 번에 여러가지 함수를 적용 가능 

```python
grouped_pct.agg([("foo", "mean"), ("bar", np.std)])
```

<img src="https://user-images.githubusercontent.com/58063806/119835667-005d7580-bf3c-11eb-8d91-0ed1387665f9.png" width=30%/>

- 컬럼의 이름을 지정 가능

```python
grouped.agg({"tip":np.max, "size":"sum"})
```

<img src="C:\Users\0864h\AppData\Roaming\Typora\typora-user-images\image-20210527224352167.png" width=25% />

- 딕셔너리를 이용해서 컬럼마다 다른 함수를 적용 가능

```python
grouped.agg({"tip_pct":["min", "max", "mean", "std"],
            "size":"sum"})
```

<img src="https://user-images.githubusercontent.com/58063806/119837464-947c0c80-bf3d-11eb-968c-a3fb6dbeeb9f.png" width=50% />

```python
tips.groupby(["day", "smoker"], as_index=False).mean()
# tips.groupby(["day", "smoker"]).mean().reset_index()
```

<img src="https://user-images.githubusercontent.com/58063806/119838312-46b3d400-bf3e-11eb-829a-84f00c462198.png" width=50% />

- as_index=False로 색인되지 않도록 할 수 있음

#### Apply : 일반적인 분리-적용-병합

```python
def top(df, n=5, column="tip_pct"):
    return df.sort_values(by=column)[-n:]

top(tips, 6)
```

<img src="https://user-images.githubusercontent.com/58063806/119841198-9398aa00-bf40-11eb-9099-1b8d9ec51c2d.png" width=50% />

- column을 기준으로 DataFrame을 정렬

```python
tips.groupby("smoker").apply(top)
```

<img src="https://user-images.githubusercontent.com/58063806/119841846-22a5c200-bf41-11eb-802a-913b3812c5f6.png" width=50%/>

- smoker를 기준으로 그룹핑한 객체를 tip_pct을 기준으로 정렬해서 상위 5개 반환

```python
tips.groupby(["smoker", "day"]).apply(top, n=1, column="total_bill")
```

<img src="https://user-images.githubusercontent.com/58063806/119842228-76181000-bf41-11eb-90db-9bc0b5ff75c4.png" width=50% />

- smoker, day를 기준으로 그룹핑한 객체를 total_bill 기준으로 정렬해서 상위 1개 반환

> apply 메서드 - pandas 객체나 스칼라값을 반환하는 함수에 사용 가능